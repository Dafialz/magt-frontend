<!-- /partials/nav.html -->
<nav class="sticky top-0 z-50 bg-neutral-900/70 backdrop-blur-xl border-b border-white/10" data-nav aria-label="Primary">
  <!-- Важливо: чекбокс ПЕРЕД панеллю і на одному рівні з нею -->
  <input type="checkbox" id="nav-burger" class="sr-only" aria-hidden="true" />

  <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
    <!-- Лого -->
    <a href="#top" class="flex items-center gap-2" aria-label="Magic Time">
      <img src="/assets/logo.png" alt="" class="w-7 h-7 rounded-xl shadow-soft" />
      <span class="font-semibold" data-i18n="nav.brand">Magic Time</span>
    </a>

    <!-- Меню + перемикач мов (desktop) -->
    <ul class="hidden md:flex items-center gap-6 text-sm" role="menubar">
      <li role="none"><a role="menuitem" href="#buy" class="hover:text-brand transition" data-i18n="nav.buy">Buy</a></li>
      <li role="none"><a role="menuitem" href="#tokenomics" class="hover:text-brand transition" data-i18n="nav.tokenomics">Tokenomics</a></li>
      <li role="none"><a role="menuitem" href="#roadmap" class="hover:text-brand transition" data-i18n="nav.roadmap">Roadmap</a></li>
      <li role="none"><a role="menuitem" href="#faq" class="hover:text-brand transition" data-i18n="nav.faq">FAQ</a></li>

      <!-- ▼ dropdown мов -->
      <li class="relative" role="none">
        <details id="lang-switcher" class="group">
          <summary class="list-none cursor-pointer flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white/5 hover:bg-white/10" aria-haspopup="listbox">
            <img id="lang-flag" src="/assets/lang/uk.png" alt="" class="w-5 h-5 rounded-full" onerror="this.style.display='none'">
            <span id="lang-label" class="hidden lg:inline">Українська</span>
            <span class="opacity-70" aria-hidden="true">▾</span>
          </summary>
          <div class="absolute right-0 mt-2 w-44 bg-neutral-900/95 border border-white/10 rounded-xl shadow-soft z-50">
            <ul class="text-sm max-h-80 overflow-auto py-1" role="listbox" aria-label="Language">
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="uk" data-label="Українська" data-flag="/assets/lang/uk.png"><img src="/assets/lang/uk.png" alt="" class="w-5 h-5 rounded-full"> Українська</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="en" data-label="English" data-flag="/assets/lang/en.png"><img src="/assets/lang/en.png" alt="" class="w-5 h-5 rounded-full"> English</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="zh" data-label="中文" data-flag="/assets/lang/cn.png"><img src="/assets/lang/cn.png" alt="" class="w-5 h-5 rounded-full"> 中文</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="es" data-label="Español" data-flag="/assets/lang/es.png"><img src="/assets/lang/es.png" alt="" class="w-5 h-5 rounded-full"> Español</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="fr" data-label="Français" data-flag="/assets/lang/fr.png"><img src="/assets/lang/fr.png" alt="" class="w-5 h-5 rounded-full"> Français</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="ru" data-label="Русский" data-flag="/assets/lang/ru.png"><img src="/assets/lang/ru.png" alt="" class="w-5 h-5 rounded-full"> Русский</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="pt" data-label="Português" data-flag="/assets/lang/pt.png"><img src="/assets/lang/pt.png" alt="" class="w-5 h-5 rounded-full"> Português</button></li>
              <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="id" data-label="Bahasa" data-flag="/assets/lang/id.png"><img src="/assets/lang/id.png" alt="" class="w-5 h-5 rounded-full"> Bahasa</button></li>
            </ul>
          </div>
        </details>
      </li>

      <!-- TonConnect кнопка (контейнер, тільки для десктопу) -->
      <li role="none">
        <div id="tonconnect" class="w-[180px] h-10"></div>
      </li>
    </ul>

    <!-- Правий блок: мобільна TonConnect + бургер -->
    <div class="flex items-center gap-3 md:hidden">
      <div id="tonconnect-mobile-inline" class="w-[150px] h-10"></div>
      <label for="nav-burger" class="p-2 rounded-lg hover:bg-white/10 cursor-pointer" aria-label="Open menu" aria-controls="mobile-panel" aria-expanded="false">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      </label>
    </div>
  </div>

  <!-- Мобільне меню -->
  <div id="mobile-panel" class="md:hidden hidden border-t border-white/10 bg-neutral-900/80 backdrop-blur-xl">
    <div class="max-w-6xl mx-auto px-4 py-4 space-y-4">
      <a href="#buy" class="block py-1 hover:text-brand" data-i18n="nav.buy">Buy</a>
      <a href="#tokenomics" class="block py-1 hover:text-brand" data-i18n="nav.tokenomics">Tokenomics</a>
      <a href="#roadmap" class="block py-1 hover:text-brand" data-i18n="nav.roadmap">Roadmap</a>
      <a href="#faq" class="block py-1 hover:text-brand" data-i18n="nav.faq">FAQ</a>

      <!-- Мови (мобільна версія) -->
      <details id="lang-switcher-mobile" class="pt-2">
        <summary class="list-none cursor-pointer flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10" aria-haspopup="listbox">
          <img id="lang-flag-m" src="/assets/lang/uk.png" alt="" class="w-5 h-5 rounded-full" onerror="this.style.display='none'">
          <span id="lang-label-m">Українська</span>
          <span class="opacity-70" aria-hidden="true">▾</span>
        </summary>
        <div class="mt-2 w-full bg-neutral-900/95 border border-white/10 rounded-xl shadow-soft">
          <ul class="text-sm max-h-80 overflow-auto py-1" role="listbox" aria-label="Language">
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="uk" data-label="Українська" data-flag="/assets/lang/uk.png"><img src="/assets/lang/uk.png" alt="" class="w-5 h-5 rounded-full"> Українська</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="en" data-label="English" data-flag="/assets/lang/en.png"><img src="/assets/lang/en.png" alt="" class="w-5 h-5 rounded-full"> English</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="zh" data-label="中文" data-flag="/assets/lang/cn.png"><img src="/assets/lang/cn.png" alt="" class="w-5 h-5 rounded-full"> 中文</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="es" data-label="Español" data-flag="/assets/lang/es.png"><img src="/assets/lang/es.png" alt="" class="w-5 h-5 rounded-full"> Español</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="fr" data-label="Français" data-flag="/assets/lang/fr.png"><img src="/assets/lang/fr.png" alt="" class="w-5 h-5 rounded-full"> Français</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="ru" data-label="Русский" data-flag="/assets/lang/ru.png"><img src="/assets/lang/ru.png" alt="" class="w-5 h-5 rounded-full"> Русский</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="pt" data-label="Português" data-flag="/assets/lang/pt.png"><img src="/assets/lang/pt.png" alt="" class="w-5 h-5 rounded-full"> Português</button></li>
            <li><button type="button" class="flex items-center gap-2 w-full px-3 py-2 hover:bg-white/10" data-lang="id" data-label="Bahasa" data-flag="/assets/lang/id.png"><img src="/assets/lang/id.png" alt="" class="w-5 h-5 rounded-full"> Bahasa</button></li>
          </ul>
        </div>
      </details>

      <!-- TonConnect кнопка (контейнер в дроуері) -->
      <div id="tonconnect-mobile" class="w-full h-10"></div>
    </div>
  </div>

  <!-- Мінімальний CSS для мобільного меню -->
  <style>
    #nav-burger:checked ~ #mobile-panel { display: block; }
    label[for="nav-burger"] { -webkit-tap-highlight-color: transparent; }
  </style>

  <!-- Поведінка мобільного меню -->
  <script>
    (function () {
      const burger = document.getElementById('nav-burger');
      const panel  = document.getElementById('mobile-panel');
      const label  = document.querySelector('label[for="nav-burger"]');
      const langDetails = document.getElementById('lang-switcher-mobile');
      const langSummary = langDetails?.querySelector('summary');

      function setAria() { if (label) label.setAttribute('aria-expanded', burger.checked ? 'true' : 'false'); }
      function closeMenu() { if (burger.checked) { burger.checked = false; setAria(); } }

      /* --- коректне визначення кліків усередині TonConnect/діалогів (включно з shadow DOM) --- */
      function isInsideTonOrDialogFromEvent(e){
        const path = (typeof e.composedPath === 'function') ? e.composedPath() : [];
        for (const n of path){
          if (!n || !(n instanceof Node)) continue;
          if (n.nodeType !== 1) continue; // тільки елементи
          const el = /** @type {Element} */(n);

          // прямі збіги
          if (
            el.matches?.('.tc-modal, .tc-root, .tc-overlay, [data-tc-widget], [class*="ton-connect"], [id^="tc-"], [role="dialog"], dialog, .modal, .overlay, tonconnect-ui, ton-connect-ui, tonconnect-ui-modal, ton-connect-ui-modal')
          ) return true;

          // якщо це хост shadow DOM із id/class TonConnect
          const host = (el.shadowRoot && el.shadowRoot.host) ? el.shadowRoot.host : null;
          if (host && (host.id?.startsWith?.('tc-') || (host.className && String(host.className).includes('ton-connect')))) return true;
        }
        return false;
      }

      /* 1) НЕ закриваємо меню коли користувач лише відкриває dropdown мов */
      langSummary?.addEventListener('click', (e) => e.stopPropagation());
      langDetails?.addEventListener('click', (e) => e.stopPropagation());

      /* 2) Закриваємо, коли натискають реальний пункт: <a> або <button> */
      panel?.addEventListener('click', (e) => {
        const t = e.target.closest('a,button'); // <summary> виключено
        if (t) closeMenu();
      });

      /* 3) Клік/тап поза панеллю (і не по label), але ІГНОРУЄМО TonConnect/діалоги (включно з shadow DOM) */
      function onDocTap(e) {
        if (!burger.checked) return;
        const t = e.target;
        if (t.closest?.('#mobile-panel') || t.closest?.('label[for="nav-burger"]')) return;

        // якщо відкрита TonConnect-модалка — нічого не чіпаємо
        if (window.__tc_open || document.querySelector('.tc-modal, .tc-overlay, [id^="tc-"]') || isInsideTonOrDialogFromEvent(e)) return;

        closeMenu();
      }
      document.addEventListener('click', onDocTap, false);
      document.addEventListener('pointerdown', onDocTap, { passive: true });

      /* 4) Esc або зміна хеша */
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
      window.addEventListener('hashchange', closeMenu);

      /* 5) aria-expanded підтримуємо в актуальному стані */
      burger.addEventListener('change', setAria);
      setAria();
    })();
  </script>
</nav>
